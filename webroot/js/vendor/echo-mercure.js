(()=>{var h=class{constructor(e,t){this.connector=e,this.name=t,this.isSubscribed=!1,this.listeners={},this.subscribedCallbacks=[],this.errorCallbacks=[]}listen(e,t){return this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t),this.isSubscribed||this.connector.subscribe(this.name),this}listenToAll(e){return this.listen("*",e)}listenForWhisper(e,t){return this.listen(".client-"+e,t)}stopListeningForWhisper(e,t){return this.stopListening(".client-"+e,t)}notification(e){return this.listen(".Illuminate\\Notifications\\Events\\BroadcastNotificationCreated",e)}stopListening(e,t){return this.listeners[e]&&(t?this.listeners[e]=this.listeners[e].filter(s=>s!==t):delete this.listeners[e]),this}subscribed(e){return this.subscribedCallbacks.push(e),this.isSubscribed&&e(),this}error(e){return this.errorCallbacks.push(e),this}trigger(e,t){this.listeners[e]&&this.listeners[e].forEach(s=>{try{s(t)}catch(r){console.error(`Error in channel listener for ${this.name}.${e}:`,r)}}),this.listeners["*"]&&this.listeners["*"].forEach(s=>{try{s(e,t)}catch(r){console.error(`Error in wildcard listener for ${this.name}:`,r)}})}triggerSubscribed(e){e==="subscribed"&&this.subscribedCallbacks.forEach(t=>{try{t()}catch(s){console.error("Error in subscribed callback:",s)}})}unsubscribe(){this.isSubscribed=!1}};var o=class extends h{constructor(e,t){let s=t.startsWith("private-")?t:`private-${t}`;super(e,s)}};var c=class{constructor(e){this.options=Object.assign({mercureUrl:"/.well-known/mercure",authEndpoint:"/broadcasting/auth",namespace:"App.Events"},e||{}),e&&e.mercure&&(this.options.mercureUrl=e.mercure.url||this.options.mercureUrl),e&&e.authEndpoint&&(this.options.authEndpoint=e.authEndpoint),this.channels={},this.eventSource=null,this.connected=!1,this.pendingChannels=[],this.authTimeout=null,this.authPromise=null,this.eventSourceChannels=[],this.listeners={}}connect(){}channel(e){return this.channels[e]||(this.channels[e]=new h(this,e)),this.channels[e]}privateChannel(e){let t=`private-${e}`;return this.channels[t]||(this.channels[t]=new o(this,t)),this.channels[t]}presenceChannel(e){let t=`presence-${e}`;return this.channel(t)}subscribe(e){let t=this.channels[e];return t&&t.isSubscribed?Promise.resolve():(this.pendingChannels.includes(e)||this.pendingChannels.push(e),this.scheduleAuth(),this.authPromise||Promise.resolve())}scheduleAuth(){this.authTimeout&&clearTimeout(this.authTimeout),this.authTimeout=setTimeout(()=>{this.requestAuth()},50)}async requestAuth(){if(this.authPromise)return this.authPromise;let e=this.eventSourceChannels||[],t=[...this.pendingChannels],s=[...new Set([...e,...t])];return this.pendingChannels=[],this.authPromise=fetch(this.options.authEndpoint,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":this.getCsrfToken()},credentials:"include",body:JSON.stringify({channel_names:s})}).then(r=>{if(!r.ok)throw new Error(`Auth failed: ${r.statusText}`);return r.json()}).then(r=>(this.updateEventSource(r.topics,r.token,s),this.authPromise=null,r)).catch(r=>{throw this.authPromise=null,console.error("Mercure auth error:",r),r}),this.authPromise}updateEventSource(e,t,s){let r=s.sort().join(",");if((this.eventSourceChannels||[]).sort().join(",")===r&&this.eventSource){s.forEach(n=>{this.channels[n]&&!this.channels[n].isSubscribed&&(this.channels[n].isSubscribed=!0,this.channels[n].triggerSubscribed("subscribed"))});return}this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.eventSourceChannels=[...s];let i=new URL(this.options.mercureUrl,window.location.origin);this.eventSourceChannels.forEach(n=>{i.searchParams.append("topic",n)}),i.searchParams.append("authorization",t),this.eventSource=new EventSource(i.toString()),this.setupEventSource(),this.eventSourceChannels.forEach(n=>{this.channels[n]&&(this.channels[n].isSubscribed=!0,this.channels[n].triggerSubscribed("subscribed"))})}setupEventSource(){this.eventSource.onopen=()=>{this.connected=!0,this.emit("connected")},this.eventSource.onerror=e=>{this.connected=!1,this.emit("error",e)},this.eventSource.onmessage=e=>{this.handleMessage(e)}}handleMessage(e){try{let t=JSON.parse(e.data),s=t.event,r=t.data,l=t.channel;if(l&&this.channels[l]){let i=this.channels[l];i&&i.isSubscribed&&i.trigger(s,r)}else this.eventSourceChannels.forEach(i=>{let n=this.channels[i];n&&n.isSubscribed&&n.trigger(s,r)})}catch(t){console.error("Error handling Mercure message:",t,e)}}getCsrfToken(){if(typeof window<"u"&&window.Laravel&&window.Laravel.csrfToken)return window.Laravel.csrfToken;let e=document.querySelector('meta[name="csrf-token"]');return e?e.getAttribute("content"):""}csrfToken(){return this.getCsrfToken()}emit(e,t){this.listeners[e]&&this.listeners[e].forEach(s=>{try{s(t)}catch(r){console.error("Error in event listener:",r)}})}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t))}leaveChannel(e){this.channels[e]&&(this.channels[e].unsubscribe(),delete this.channels[e])}socketId(){return this.connected?"mercure-connection":null}disconnect(){this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.connected=!1,this.emit("disconnected")}};typeof window<"u"&&(window.MercureConnector=c,window.MercureChannel=h,window.MercurePrivateChannel=o);})();
